{% extends "layout.html" %}
{% block content %}
  <h1>Monthly Portfolio Performance Report</h1>
  <p><a class="muted" href="/reports">← Back to Reports</a></p>

  {% if ok_msg %}
    <div class="banner banner--ok">{{ ok_msg }}</div>
  {% endif %}
  {% if error_msg %}
    <div class="banner banner--warn">{{ error_msg }}</div>
  {% endif %}

  <h2>Use Existing Investor Data</h2>
  <div class="box">
    <form method="post" action="/reports/monthly/run_db">
      <div class="grid3">
        <label>Scope<br/>
          <select name="scope" id="scope_sel" onchange="window.location='/reports/monthly?scope=' + this.value;">
            <option value="household" {% if scope == "household" %}selected{% endif %}>Household</option>
            <option value="trust" {% if scope == "trust" %}selected{% endif %}>Trust only</option>
            <option value="personal" {% if scope == "personal" %}selected{% endif %}>Personal only (non-IRA)</option>
            <option value="ira" {% if scope == "ira" %}selected{% endif %}>IRA only</option>
          </select>
        </label>
        <label>Portfolio<br/>
          <select name="portfolio_id" required>
            {% if portfolio_options and portfolio_options|length > 0 %}
              {% for p in portfolio_options %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            {% else %}
              <option value="">No portfolios available</option>
            {% endif %}
          </select>
        </label>
        <label>Benchmark<br/><input name="benchmark" value="VOO" /></label>
        <label>Start<br/><input name="start" value="{{ default_start }}" /></label>
        <label>End<br/><input name="end" value="{{ default_end }}" /></label>
        <label>As-of (month-end)<br/><input name="asof" value="{{ default_asof }}" /></label>
        <label>Options<br/>
          <div class="muted" style="margin-top:6px">
            <label><input type="checkbox" name="download_prices" value="true" /> Download missing prices (needs yfinance + internet)</label><br/>
            <label><input type="checkbox" name="include_fees_as_flow" value="true" /> Treat fees as external flow</label>
          </div>
        </label>
        <label>&nbsp;<br/><button type="submit">Run</button></label>
      </div>
      <div class="muted" style="margin-top:10px">
        Uses existing holdings snapshots + transactions for the selected portfolio. Outputs are written under <code>data/monthly_reports/</code>.
      </div>
    </form>
  </div>

  <h2>Upload Files</h2>
  <div class="box">
    <form method="post" action="/reports/monthly/run" enctype="multipart/form-data">
      <div class="grid3">
        <label>Start<br/><input name="start" value="{{ default_start }}" /></label>
        <label>End<br/><input name="end" value="{{ default_end }}" /></label>
        <label>As-of (month-end)<br/><input name="asof" value="{{ default_asof }}" /></label>
        <label>Benchmark<br/><input name="benchmark" value="{{ default_benchmark }}" /></label>
        <label>Options<br/>
          <div class="muted" style="margin-top:6px">
            <label><input type="checkbox" name="download_prices" value="true" /> Download missing prices (needs yfinance + internet)</label><br/>
            <label><input type="checkbox" name="include_fees_as_flow" value="true" /> Treat fees as external flow</label>
          </div>
        </label>
        <label>&nbsp;<br/><button type="submit">Run</button></label>
      </div>
      <div class="grid3" style="margin-top:12px">
        <label>transactions.csv<br/><input type="file" name="transactions" required /></label>
        <label>monthly_perf.csv<br/><input type="file" name="monthly_perf" required /></label>
        <label>holdings.csv (optional)<br/><input type="file" name="holdings" /></label>
      </div>
      <div class="muted" style="margin-top:10px">
        Outputs are written under <code>data/monthly_reports/</code> and served back via this page. Offline prices can be provided in <code>data/prices/*.csv</code>.
      </div>
    </form>
  </div>

  {% if runs and runs|length > 0 %}
    <h2>Recent Runs</h2>
    <div class="box">
      <table>
        <tr>
          <th>Run</th>
          <th>Period</th>
          <th>Benchmark</th>
          <th class="muted">TWR</th>
          <th class="muted">XIRR</th>
          <th class="muted">Warnings</th>
        </tr>
        {% for r in runs %}
          <tr>
            <td><a class="muted" href="/reports/monthly/run/{{ r.run_id }}">{{ r.run_id }}</a></td>
            <td class="muted">{{ r.start_date }} → {{ r.end_date }} (as-of {{ r.asof }})</td>
            <td class="muted">{{ r.benchmark }}</td>
            <td class="muted">{% if r.twr_ytd is none %}—{% else %}{{ "%.2f"|format(r.twr_ytd * 100.0) }}%{% endif %}</td>
            <td class="muted">{% if r.xirr is none %}—{% else %}{{ "%.2f"|format(r.xirr * 100.0) }}%{% endif %}</td>
            <td class="muted">{{ r.warnings_count if r.warnings_count is not none else "—" }}</td>
          </tr>
        {% endfor %}
      </table>
    </div>
  {% endif %}
{% endblock %}
