{% extends "layout.html" %}
{% block content %}
  <h1>Expenses</h1>
  {% if request.query_params.get("error") %}
    <div class="banner banner--warn">{{ request.query_params.get("error") }}</div>
  {% endif %}
  {% if request.query_params.get("ok") %}
    <div class="banner banner--ok">{{ request.query_params.get("ok") }}</div>
  {% endif %}

  <div class="box">
    <div class="muted">Transactions stored: {{ txn_count }} • Rules: <a href="/expenses/rules">{{ rules_path }}</a></div>
    {% if not rules_exists %}
      <div class="banner banner--warn">No rules file found. Create starter rules at <a href="/expenses/rules">/expenses/rules</a>.</div>
    {% endif %}
  </div>

	  <h2>Import statements (CSV)</h2>
	  <div class="muted">Tip: upload individual files (multi-select), or upload an entire folder; TSV works too.</div>
	  <form method="post" action="/expenses/import-batch" enctype="multipart/form-data" class="box">
	    <div class="grid3">
	      <label>Institution <input name="institution" value="Chase" /></label>
	      <label>Account label <input name="account" placeholder="Chase Freedom (optional)" /></label>
	      <label>Type
        <select name="account_type">
          <option value="CREDIT">CREDIT</option>
          <option value="BANK">BANK</option>
          <option value="UNKNOWN">UNKNOWN</option>
        </select>
      </label>
    </div>
	    <div class="grid3">
	      <label>Last4 (optional) <input name="account_last4" size="8" placeholder="1234" /></label>
	      <label>Card Member (optional) <input name="cardholder_name" placeholder="Laszlo Rausch" /></label>
	      <label>Format
	        <select name="format">
	          <option value="">(auto-detect)</option>
	          {% for f in enabled_formats %}
            <option value="{{ f }}">{{ f }}</option>
          {% endfor %}
        </select>
      </label>
      <label><input type="checkbox" name="fuzzy_dedupe" checked /> Fuzzy dedupe (date±1 + amount + merchant)</label>
    </div>
	    <label><input type="checkbox" name="store_original_rows" /> Store redacted original row JSON (off by default)</label>
	    <div style="margin-top:8px">
	      <div class="grid2">
	        <label>Files
	          <input type="file" name="files" multiple accept=".csv,.tsv" />
	        </label>
	        <label>Folder
	          <input type="file" name="dir_files" multiple webkitdirectory directory />
	        </label>
	      </div>
	      <button type="submit">Import Files/Folder</button>
	    </div>
	  </form>

    <h2>Import RJ cash outs</h2>
    <div class="muted">Creates/updates an expense account from Raymond James cash-out transfers (Kolozsi Trust).</div>
    <form method="post" action="/expenses/import-rj-cash-outs" class="box">
      <div class="grid3">
        <label>RJ account
          <select name="rj_account_id">
            <option value="">(auto)</option>
            {% for a in rj_accounts %}
              <option value="{{ a.id }}">{{ a.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label>Expense account name <input name="expense_account_name" value="Kolozsi Trust" /></label>
        <label>Year (optional) <input name="year" size="6" placeholder="2025" /></label>
      </div>
      <button type="submit">Import RJ Cash Outs</button>
    </form>

    <div class="grid2">
    <div class="box">
      <h3>Actions</h3>
      <form method="post" action="/expenses/categorize">
        <label><input type="checkbox" name="rebuild" /> Rebuild categories (system only)</label>
        <button type="submit">Categorize</button>
      </form>
      <form method="post" action="/expenses/normalize-monthly-installments" style="margin-top:8px">
        <button type="submit">Normalize Monthly Installments → Apple</button>
      </form>
      <form method="post" action="/expenses/normalize-bank-merchants" style="margin-top:8px">
        <button type="submit">Normalize Bank Merchants (reduce payee duplicates)</button>
      </form>
      <form method="post" action="/expenses/normalize-card-merchants" style="margin-top:8px">
        <button type="submit">Normalize Card Merchants (reduce vendor duplicates)</button>
      </form>
      <p class="muted">
        Reports: <a href="/expenses/reports?year={{ today[:4] }}">/expenses/reports</a> •
        Recurring: <a href="/expenses/recurring?year={{ today[:4] }}">/expenses/recurring</a> •
        Transactions: <a href="/expenses/transactions">/expenses/transactions</a> •
        Purge: <a href="/expenses/purge">/expenses/purge</a>
      </p>
    </div>
    <div class="box">
      <h3>Accounts</h3>
      {% if accounts %}
        <table>
          <thead><tr><th>Institution</th><th>Name</th><th>Type</th><th>Last4</th></tr></thead>
          <tbody>
            {% for a in accounts %}
              <tr>
                <td>{{ a.institution }}</td>
                <td><a href="/expenses/transactions?account_id={{ a.id }}">{{ a.name }}</a></td>
                <td>{{ a.type }}</td>
                <td>{{ a.last4_masked or "" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="muted">No expense accounts yet. Import a statement to create one.</div>
      {% endif %}
    </div>
  </div>

  <h2>Recent import batches</h2>
  {% if batches %}
    <div class="table-scroll">
      <table>
        <thead><tr><th>Imported</th><th>File</th><th>Format</th><th>Rows</th><th>Dupes skipped</th></tr></thead>
        <tbody>
          {% for b in batches %}
            <tr>
              <td class="nowrap">{{ b.imported_at|local_dt }}</td>
              <td class="nowrap">{{ b.file_name }}</td>
              <td>{{ (b.metadata_json or {}).get("format","") }}</td>
              <td>{{ b.row_count }}</td>
              <td>{{ b.duplicates_skipped }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">No import batches yet.</div>
  {% endif %}
{% endblock %}
