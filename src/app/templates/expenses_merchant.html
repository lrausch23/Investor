{% extends "layout.html" %}
{% block content %}
  <h1>Merchant: {{ merchant }}</h1>
  <div class="muted">
    {% if return_to %}
      <a href="{{ return_to }}">{% if "/expenses/recurring" in return_to %}Back to recurring{% else %}Back{% endif %}</a> •
    {% endif %}
    <a href="/expenses/reports?year={{ year }}{% if month %}&month={{ month }}{% endif %}{% if account_id and account_id!='0' %}&account_id={{ account_id }}{% endif %}">Back to reports</a> •
    <a href="/expenses/merchants?year={{ year }}{% if month %}&month={{ month }}{% endif %}{% if account_id and account_id!='0' %}&account_id={{ account_id }}{% endif %}">All merchants</a>
  </div>

  <div class="box">
    <div class="muted">Totals for this merchant (selected period)</div>
    <div>Spend: <strong>{{ spend_total|usd }}</strong> • Payment/Credits: <strong>{{ income_total|usd }}</strong> • Net: <strong>{{ (spend_total - income_total)|usd }}</strong></div>
  </div>

  <div class="box">
    <div class="muted">Assign category to this merchant (applies to charge transactions; saved as a rule)</div>
    <form method="post" action="/expenses/merchant/category">
      <input type="hidden" name="merchant" value="{{ merchant }}" />
      <input type="hidden" name="return_to" value="{{ request.url }}" />
      <label>Category
        <select name="category">
          <option value="">(select)</option>
          {% for c in categories %}
            <option value="{{ c }}" {% if merchant_category==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </label>
      <input name="new_category" placeholder="New category" size="18" />
      <button type="submit">Save</button>
    </form>
  </div>

  <div class="box">
    <div class="muted">Recurring settings for this merchant (affects recurring report only)</div>
    <form method="post" action="/expenses/merchant/recurring">
      <input type="hidden" name="merchant" value="{{ merchant }}" />
      <input type="hidden" name="return_to" value="{{ request.url }}" />
      <label>
        <input type="checkbox" name="recurring_enabled" value="1" {% if recurring_setting and recurring_setting.recurring_enabled %}checked{% endif %}/>
        Mark as recurring
      </label>
      <label>Frequency
        <select name="cadence">
          {% set sel = (recurring_setting.cadence if recurring_setting else "UNKNOWN") %}
          <option value="UNKNOWN" {% if sel=="UNKNOWN" %}selected{% endif %}>(auto)</option>
          <option value="WEEKLY" {% if sel=="WEEKLY" %}selected{% endif %}>Weekly</option>
          <option value="MONTHLY" {% if sel=="MONTHLY" %}selected{% endif %}>Monthly</option>
          <option value="QUARTERLY" {% if sel=="QUARTERLY" %}selected{% endif %}>Quarterly</option>
          <option value="SEMIANNUAL" {% if sel=="SEMIANNUAL" %}selected{% endif %}>Semiannual</option>
          <option value="ANNUAL" {% if sel=="ANNUAL" %}selected{% endif %}>Annual</option>
        </select>
      </label>
      <button type="submit">Save</button>
    </form>
  </div>

  {% if txns %}
    <div class="table-scroll table-scroll--resizable">
      <table>
        <thead>
          <tr>
            <th class="col-date">Posted</th>
            <th>Account</th>
            <th>Cardholder</th>
            <th>Description</th>
            <th>Category</th>
            <th class="nowrap num">Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for t in txns %}
            <tr>
              <td class="nowrap">{{ t.posted_date }}</td>
              <td class="nowrap">
                {{ t.institution }} {% if t.account_last4_masked %}****{{ t.account_last4_masked }}{% elif t.expense_account and t.expense_account.last4_masked %}****{{ t.expense_account.last4_masked }}{% endif %}
              </td>
              <td class="nowrap">{{ t.cardholder_name or "" }}</td>
              <td>{{ t.description_norm }}</td>
              <td class="nowrap">{{ t.category_user or t.category_system or "Unknown" }}</td>
              <td class="nowrap num">{{ t.amount|usd }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">No transactions found for this merchant.</div>
  {% endif %}
{% endblock %}
