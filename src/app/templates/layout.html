<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "Investor MVP" }}</title>
    <link rel="stylesheet" href="/static/app.css?v={{ static_version or '0' }}" />
  </head>
  <body>
    <header class="topbar">
      <div class="topbar__left">
        <a href="/holdings">Holdings</a>
        <a href="/cash-bills">Cash &amp; Bills</a>
        <a href="/expenses">Expenses</a>
        <a href="/sync/connections">Sync</a>
        <a href="/reports">Reports</a>
        <a href="/taxes">Taxes</a>
        <div class="topbar__dropdown">
          <a class="topbar__link" href="/maintenance" aria-haspopup="menu" aria-expanded="false">Maintenance ▾</a>
          <div class="dropdown__menu" role="menu">
            <a class="dropdown__item" href="/maintenance" role="menuitem">Maintenance overview</a>
            <a class="dropdown__item" href="/dashboard" role="menuitem">Dashboard</a>
            <a class="dropdown__item" href="/setup" role="menuitem">Setup</a>
            <a class="dropdown__item" href="/policy" role="menuitem">Policy</a>
            <a class="dropdown__item" href="/holdings/bullion" role="menuitem">Bullion</a>
            <a class="dropdown__item" href="/holdings/cash" role="menuitem">Holdings cash</a>
            <a class="dropdown__item" href="/holdings/transactions" role="menuitem">Holdings transactions</a>
            <a class="dropdown__item" href="/holdings/lots" role="menuitem">Lots</a>
            <a class="dropdown__item" href="/taxlots/gains?source=auto" role="menuitem">Tax lots</a>
            <a class="dropdown__item" href="/holdings/income" role="menuitem">Income</a>
            <a class="dropdown__item" href="/holdings/assignments" role="menuitem">Mappings</a>
            <a class="dropdown__item" href="/holdings/securities" role="menuitem">Securities</a>
            <a class="dropdown__item" href="/imports" role="menuitem">Imports</a>
            <a class="dropdown__item" href="/planner" role="menuitem">Planner</a>
            <a class="dropdown__item" href="/plans" role="menuitem">Plans</a>
            <a class="dropdown__item" href="/momentum" role="menuitem">Momentum</a>
            <a class="dropdown__item" href="/tax/summary" role="menuitem">Tax</a>
            <a class="dropdown__item" href="/audit" role="menuitem">Audit</a>
          </div>
        </div>
      </div>
      <div class="topbar__right">
        Actor: {{ actor }}{% set auth_label = auth_status_label() %}{% if auth_label %} · Auth: {{ auth_label }}{% endif %}
      </div>
    </header>
    <div class="app-content">
      {% if auth_banner %}
        <div class="banner banner--warn">{{ auth_banner }}</div>
      {% endif %}
      <main class="container">
        {% block content %}{% endblock %}
      </main>
    </div>
    <script>
      (() => {
        const topbar = document.querySelector(".topbar");
        if (!topbar) return;
        let ticking = false;
        const setTopbarHeightVar = () => {
          try {
            const h = Math.ceil(topbar.getBoundingClientRect().height || 0);
            if (h > 0) document.documentElement.style.setProperty("--top-nav-height", `${h}px`);
          } catch {
            // ignore
          }
        };
        const apply = () => {
          ticking = false;
          topbar.classList.toggle("is-scrolled", (window.scrollY || 0) > 0);
        };
        const onScroll = () => {
          if (ticking) return;
          ticking = true;
          window.requestAnimationFrame(apply);
        };
        setTopbarHeightVar();
        apply();
        window.addEventListener("scroll", onScroll, { passive: true });
        window.addEventListener("resize", setTopbarHeightVar, { passive: true });

        // Keep offsets correct if the nav height changes due to wrapping, font load, or responsive reflow.
        try {
          if ("ResizeObserver" in window) {
            const ro = new ResizeObserver(() => setTopbarHeightVar());
            ro.observe(topbar);
          }
        } catch {
          // ignore
        }
        try {
          if (document.fonts && document.fonts.ready) {
            document.fonts.ready.then(() => setTopbarHeightVar()).catch(() => {});
          }
        } catch {
          // ignore
        }
      })();

      (() => {
        const dropdown = document.querySelector(".topbar__dropdown");
        if (!dropdown) return;
        const trigger = dropdown.querySelector(".topbar__link");
        const menu = dropdown.querySelector(".dropdown__menu");
        if (!trigger || !menu) return;

        const setOpen = (isOpen) => {
          dropdown.classList.toggle("is-open", isOpen);
          trigger.setAttribute("aria-expanded", isOpen ? "true" : "false");
        };

        trigger.addEventListener("click", (event) => {
          event.preventDefault();
          setOpen(!dropdown.classList.contains("is-open"));
        });

        trigger.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            setOpen(!dropdown.classList.contains("is-open"));
          }
          if (event.key === "Escape") setOpen(false);
        });

        document.addEventListener("click", (event) => {
          if (!dropdown.contains(event.target)) setOpen(false);
        });

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") setOpen(false);
        });
      })();
    </script>
  </body>
</html>
