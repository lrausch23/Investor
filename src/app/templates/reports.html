{% extends "layout.html" %}
{% block content %}
  {% from "partials/ui/components.html" import kpi_card %}
  {% set report_breadcrumbs = [{"label": "Reports", "href": "/reports"}, {"label": "Cash Out", "href": None}] %}
  {% set report_title = "Cash Out" %}
  {% set report_badge = "Report" %}
  {% set report_context = "<b>Period:</b> " ~ period_label ~ " <span class='ui-muted'>·</span> <b>View:</b> " ~ ("Per account" if view == "accounts" else "Combined") %}
  {% include "partials/reports/_header.html" %}

  <div class="ui-kpi-grid">
    <a class="ui-card report-tile" href="/reports/performance">
      <div class="ui-card__label">Performance</div>
      <div class="report-tile__title">IRR / TWR / Sharpe</div>
      <div class="ui-card__subtext ui-muted">Holdings snapshots + transfers</div>
    </a>
    <a class="ui-card report-tile" href="/reports/monthly">
      <div class="ui-card__label">Monthly report</div>
      <div class="report-tile__title">Monthly Performance</div>
      <div class="ui-card__subtext ui-muted">Run pipeline + browse artifacts</div>
    </a>
  </div>

  <div class="ui-card" style="margin-top:10px">
    <div class="ui-section-title">Filters</div>
    <form method="get" action="/reports">
      <input type="hidden" name="scope" value="{{ scope }}"/>
      <div class="report-filters-grid">
        <label>Date range<br/>
          <select name="period" id="period_sel" onchange="toggleYear()">
            <option value="ytd" {% if period == "ytd" %}selected{% endif %}>YTD</option>
            <option value="year" {% if period == "year" %}selected{% endif %}>Calendar year</option>
          </select>
        </label>
        <label id="year_wrap">Year<br/>
          <select name="year">
            {% for y in year_options %}
              <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </label>
        <label>View<br/>
          <select name="view">
            <option value="accounts" {% if view == "accounts" %}selected{% endif %}>Per account</option>
            <option value="combined" {% if view == "combined" %}selected{% endif %}>Combined</option>
          </select>
        </label>
        <div class="report-filters-actions">
          <button class="btn btn--primary" type="submit">Run report</button>
          <div class="ui-muted" style="margin-top:6px">Runs using the latest imported transactions.</div>
        </div>
      </div>

      <details class="ui-disclosure" style="margin-top:12px">
        <summary>What’s included</summary>
        <div class="ui-muted" style="margin-top:8px">
          Cash out includes: Withdrawals (<code>TRANSFER</code>, <code>amount &lt; 0</code>), Fees (<code>FEE</code>),
          Taxes withheld (<code>WITHHOLDING</code>), and Other cash out (<code>OTHER</code>, <code>amount &lt; 0</code>).
          Deposits are <code>TRANSFER</code> with <code>amount &gt; 0</code>.
          <div style="margin-top:6px">
            Net cash out = Total cash out − Deposits.
          </div>
        </div>
      </details>
    </form>
  </div>

  <div class="ui-kpi-grid">
    {{ kpi_card("Total deposits", (combined_deposit_total or 0.0)|usd(2), subtext=(combined_deposit_count or 0) ~ " txn(s)") }}
    {{ kpi_card("Total withdrawals", (combined_withdrawal_total or 0.0)|usd(2), subtext=(combined_withdrawal_count or 0) ~ " txn(s)") }}
    {{ kpi_card("Total fees", (combined_fee_total or 0.0)|usd(2), subtext=(combined_fee_count or 0) ~ " txn(s)") }}
    {{ kpi_card("Taxes withheld", (combined_withholding_total or 0.0)|usd(2), subtext=(combined_withholding_count or 0) ~ " txn(s)") }}
    {{ kpi_card("Other cash out", (combined_other_total or 0.0)|usd(2), subtext=(combined_other_count or 0) ~ " txn(s)") }}
    {{ kpi_card("Net cash out", (combined_net_total or 0.0)|usd(2), subtext="Net = total cash out − deposits") }}
  </div>

  {% if view == "combined" %}
    {% if rows and rows|length > 0 %}
      <div class="ui-card">
        <div class="ui-section-title">Accounts</div>
        <div class="ui-muted">Select an account for transaction-level details.</div>
        <div class="table-wrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th scope="col">Account</th>
                <th scope="col">Taxpayer</th>
                <th scope="col" class="num">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
                <tr>
                  <td>{{ r.account_name }}</td>
                  <td class="ui-muted">{{ r.taxpayer_name }} ({{ r.taxpayer_type }})</td>
                  <td class="num">
                    <a class="btn btn--secondary btn--sm" href="/reports?scope={{ scope }}&period={{ period }}&year={{ year }}&view={{ view }}&account_id={{ r.account_id }}">Details</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  {% else %}
    {% if rows and rows|length > 0 %}
      <div class="ui-card">
        <div class="ui-section-title">Results</div>
        <div class="table-wrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th scope="col">Account</th>
                <th scope="col">Taxpayer</th>
                {% if show_overall %}
                  <th scope="col" class="num">Overall</th>
                {% endif %}
                <th scope="col" class="num">Deposits</th>
                <th scope="col" class="num">Withdrawals</th>
                <th scope="col" class="num">Fees</th>
                <th scope="col" class="num">Taxes withheld</th>
                <th scope="col" class="num">Other cash out</th>
                <th scope="col" class="num">CSV</th>
                <th scope="col" class="num">Total cash out</th>
                <th scope="col" class="num">Net cash out</th>
                <th scope="col" class="num">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
                <tr>
                  <td>{{ r.account_name }}</td>
                  <td class="ui-muted">{{ r.taxpayer_name }} ({{ r.taxpayer_type }})</td>
                  {% if show_overall %}
                    {% set tot = ((r.withdrawal_total or 0.0)|float) + ((r.fee_total or 0.0)|float) + ((r.withholding_total or 0.0)|float) + ((r.other_total or 0.0)|float) %}
                    <td class="num ui-muted">
                      {% if (combined_total or 0.0) > 0 %}
                        {{ ((100.0 * tot / combined_total)|round(1)) }}%
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  {% endif %}
                  <td class="num ui-muted">{{ (r.deposit_total or 0.0)|usd(2) }} <span class="ui-muted">({{ r.deposit_count or 0 }})</span></td>
                  <td class="num ui-muted">{{ (r.withdrawal_total or 0.0)|usd(2) }} <span class="ui-muted">({{ r.withdrawal_count or 0 }})</span></td>
                  <td class="num ui-muted">{{ (r.fee_total or 0.0)|usd(2) }} <span class="ui-muted">({{ r.fee_count or 0 }})</span></td>
                  <td class="num ui-muted">{{ (r.withholding_total or 0.0)|usd(2) }} <span class="ui-muted">({{ r.withholding_count or 0 }})</span></td>
                  <td class="num ui-muted">{{ (r.other_total or 0.0)|usd(2) }} <span class="ui-muted">({{ r.other_count or 0 }})</span></td>
                  <td class="num ui-muted">
                    {% if (r.csv_count or 0) > 0 %}
                      <span class="ui-badge ui-badge--neutral">CSV</span>
                      <span class="ui-tabular-nums">{{ (r.csv_total or 0.0)|usd(2) }}</span>
                      <span class="ui-muted">({{ r.csv_count or 0 }})</span>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td class="num">
                    {% if not show_overall %}
                      {% set tot = ((r.withdrawal_total or 0.0)|float) + ((r.fee_total or 0.0)|float) + ((r.withholding_total or 0.0)|float) + ((r.other_total or 0.0)|float) %}
                    {% endif %}
                    {{ tot|usd(2) }}
                  </td>
                  <td class="num ui-muted">{{ (tot - ((r.deposit_total or 0.0)|float))|usd(2) }}</td>
                  <td class="num">
                    <a class="btn btn--secondary btn--sm" href="/reports?scope={{ scope }}&period={{ period }}&year={{ year }}&view={{ view }}&account_id={{ r.account_id }}">Details</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="alert" role="note">No cash-out transactions found for this period/scope.</div>
    {% endif %}
  {% endif %}

  {% if selected_account %}
    <details class="ui-disclosure" open style="margin-top:14px">
      <summary>Details: {{ selected_account.name }}</summary>
      <div class="ui-muted" style="margin-top:8px">
        Showing deposits + cash out (withdrawals, fees, taxes withheld, other) for {{ period_label }}.
        <a class="ui-muted" href="/reports?scope={{ scope }}&period={{ period }}&year={{ year }}&view={{ view }}">Clear selection</a>
      </div>
      {% if detail_rows and detail_rows|length > 0 %}
        <div class="table-wrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th scope="col">Date</th>
                <th scope="col">Flow</th>
                <th scope="col">Type</th>
                <th scope="col" class="num">Amount</th>
                <th scope="col">Description</th>
                <th scope="col">Additional detail</th>
                <th scope="col">Source</th>
                <th scope="col">Provider txn id</th>
              </tr>
            </thead>
            <tbody>
              {% for t, m, c in detail_rows %}
                <tr>
                  <td class="nowrap">{{ t.date }}</td>
                  <td class="ui-muted">
                    {% if t.type == "TRANSFER" %}
                      {% if t.amount > 0 %}DEPOSIT{% else %}WITHDRAWAL{% endif %}
                    {% elif t.type == "WITHHOLDING" %}
                      TAX
                    {% else %}
                      CASH OUT
                    {% endif %}
                  </td>
                  <td class="ui-muted">{{ t.type }}</td>
                  {% if t.type == "TRANSFER" %}
                    <td class="num">{{ (t.amount if t.amount > 0 else (-t.amount))|usd(2) }}</td>
                  {% elif t.type == "WITHHOLDING" %}
                    <td class="num">{{ (t.amount)|usd(2) }}</td>
                  {% else %}
                    <td class="num">{{ (-t.amount)|usd(2) }}</td>
                  {% endif %}
                  <td class="ui-muted">{{ (t.lot_links_json.get("description") if t.lot_links_json else "") or "" }}</td>
                  <td class="ui-muted">{{ (t.lot_links_json.get("additional_detail") if t.lot_links_json else "") or "" }}</td>
                  <td class="ui-muted">
                    {% set src = (t.lot_links_json.get("source") if t.lot_links_json else "") %}
                    {% if src == "CSV_SUPPLEMENTAL" %}
                      <span class="ui-badge ui-badge--neutral">CSV</span>
                      {% if c %}<span class="ui-muted">#{{ c.id }} — {{ c.name }}</span>{% endif %}
                    {% elif c %}
                      #{{ c.id }} — {{ c.name }}
                    {% else %}
                      Manual
                    {% endif %}
                  </td>
                  <td class="ui-muted">{{ m.provider_txn_id if m else "" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert" role="note" style="margin-top:10px">No cash-out transactions found for this account in this period.</div>
      {% endif %}
    </details>
  {% elif account_id %}
    <div class="alert alert--warn" role="alert">Selected account is not available in this scope.</div>
  {% endif %}

  <script>
    function toggleYear() {
      const sel = document.getElementById("period_sel");
      const wrap = document.getElementById("year_wrap");
      if (!sel || !wrap) return;
      wrap.style.display = (sel.value === "year") ? "block" : "none";
    }
    toggleYear();
  </script>
{% endblock %}
