<section class="ui-card" aria-label="Actions">
  <div class="ui-section-title">Actions</div>

  <div class="ui-muted">
    Sync pulls new activity and/or ingests new files for this connection. Disabled connections cannot sync.
  </div>

  <form method="post" action="/sync/connections/{{ conn.id }}/run" class="form-compact" style="margin-top:10px">
    <label>
      <span>Mode</span>
      <select name="mode" data-sync-mode-select data-conn-id="{{ conn.id }}">
        <option value="INCREMENTAL" selected>INCREMENTAL</option>
        <option value="FULL">FULL</option>
      </select>
    </label>

    <div class="grid3">
      <label>
        <span>Overlap days (0–30)</span>
        <input name="overlap_days" value="7" inputmode="numeric"/>
      </label>
      <label>
        <span>Store raw payload snapshots</span>
        <input type="checkbox" name="store_payloads" id="payloads_{{ conn.id }}"/>
      </label>
      <label>
        <span>Reprocess payloads/files</span>
        <input type="checkbox" name="reprocess_files"/>
      </label>
    </div>

    <div id="full_fields_{{ conn.id }}" class="box" hidden>
      <b>FULL range</b>
      <div class="grid3" style="margin-top:6px">
        <label>
          <span>Start date</span>
          <input name="start_date" value="{{ ten_years_ago }}" placeholder="YYYY-MM-DD (or MM/DD/YYYY)"/>
        </label>
        <label>
          <span>End date</span>
          <input name="end_date" value="{{ today }}" placeholder="YYYY-MM-DD (or MM/DD/YYYY)"/>
        </label>
      </div>
      <div class="ui-muted" style="margin-top:6px">Tip: FULL defaults to storing payload snapshots.</div>
    </div>

    <div id="inc_fields_{{ conn.id }}" class="box">
      <b>INCREMENTAL</b>
      <div class="ui-muted" style="margin-top:6px">
        Last successful sync: {{ conn.last_successful_sync_at|local_dt if conn.last_successful_sync_at else "—" }}.
        Default computed since (overlap=7): {{ since_default or "today-90d" }}.
      </div>
      <label style="margin-top:6px">
        <span>Override start date (optional)</span>
        <input name="start_date" value=""/>
      </label>
      <label>
        <span>End date (ignored; uses today)</span>
        <input name="end_date" value="" disabled/>
      </label>
    </div>

    <label>
      <span>Audit note (optional)</span>
      <input name="note" placeholder="Why this sync was run"/>
    </label>

    <button class="btn btn--primary" type="submit" {% if status_u != "ACTIVE" %}disabled{% endif %}>Sync now</button>
  </form>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
    <form method="post" action="/sync/connections/{{ conn.id }}/test">
      <button class="btn btn--secondary" type="submit" {% if status_u != "ACTIVE" %}disabled{% endif %}>Test connection</button>
    </form>
    {% if not is_offline_files %}
      <a class="btn" href="/sync/connections/{{ conn.id }}/auth">Credentials</a>
    {% endif %}
    <details class="dropdown">
      <summary class="btn" aria-label="More actions">More</summary>
      <div class="dropdown__menu" role="menu">
        <a class="dropdown__item" href="/sync/connections/{{ conn.id }}" role="menuitem">View page</a>
        {% if not is_offline_files %}
          <a class="dropdown__item" href="/sync/connections/{{ conn.id }}/auth" role="menuitem">Edit credentials</a>
        {% endif %}
        <form method="post" action="/sync/connections/{{ conn.id }}/disable" data-confirm-disable data-conn-name="{{ conn.name|e }}">
          <input type="hidden" name="note" value="Disabled from connection detail page"/>
          <button class="dropdown__danger" type="submit" role="menuitem">Disable connection</button>
        </form>
      </div>
    </details>
  </div>

  <details class="ui-disclosure" style="margin-top:12px">
    <summary>Quick actions</summary>
    <div style="margin-top:10px; display:grid; gap:10px">
      <form method="post" action="/sync/connections/{{ conn.id }}/run">
        <input type="hidden" name="mode" value="FULL"/>
        <input type="hidden" name="start_date" value="{{ ten_years_ago }}"/>
        <input type="hidden" name="end_date" value="{{ today }}"/>
        <input type="hidden" name="overlap_days" value="7"/>
        <input type="hidden" name="store_payloads" value=""/>
        <input type="hidden" name="reprocess_files" value=""/>
        <input type="hidden" name="note" value=""/>
        <button class="btn" type="submit" {% if status_u != "ACTIVE" %}disabled{% endif %}>Run FULL backfill</button>
      </form>
      {% if is_offline_files %}
        <form method="post" action="/sync/connections/{{ conn.id }}/run">
          <input type="hidden" name="mode" value="FULL"/>
          <input type="hidden" name="start_date" value="{{ ten_years_ago }}"/>
          <input type="hidden" name="end_date" value="{{ today }}"/>
          <input type="hidden" name="overlap_days" value="7"/>
          <input type="hidden" name="store_payloads" value=""/>
          <input type="hidden" name="reprocess_files" value="on"/>
          <input type="hidden" name="note" value=""/>
          <button class="btn" type="submit" {% if status_u != "ACTIVE" %}disabled{% endif %}>Run FULL backfill (reprocess)</button>
        </form>
      {% endif %}
    </div>
  </details>
</section>
